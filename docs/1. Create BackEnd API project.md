
# Crear un nuevo proyecto de ASP.NET Core

1. Cree el proyecto usando `dotnet new webapi` en la línea cmd, detalles de la siguiente manera:

* Cree la carpeta ConferencePlanner y llame a `dotnet new sln` en la línea cmd para crear una solución
*  Cree la subcarpeta BackEnd y cree un proyecto usando `dotnet new webapi` en la línea cmd dentro de la carpeta BackEnd
*  Agregue el proyecto a la solución usando `dotnet sln add BackEnd/BackEnd.csproj`

2. Agregue una nueva carpeta `Models` a la raíz de la aplicación.
   
3. Agregue una nueva clase `Speaker` con el siguiente código:
    
```csharp
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Threading.Tasks;
namespace BackEnd.Models
{
    public class Speaker
    {
       public int Id { get; set; }
       [Required]
       [StringLength(200)]
       public string Name { get; set; }
       [StringLength(4000)]
       public string Bio { get; set; }
       [StringLength(1000)]
       public virtual string WebSite { get; set; }
    }
}
```

4. Agregue una referencia al paquete NuGet `Microsoft.EntityFrameworkCore.SqlServer` versión` 3.1.1` desde la línea de comandos usando 
   
```
dotnet add package Microsoft.EntityFrameworkCore.SqlServer --version 3.1.1
```
   
5. Agregue una referencia al paquete NuGet `Microsoft.EntityFrameworkCore.Sqlite` versión` 3.1.1` desde la línea de comandos usando 

```
dotnet add package Microsoft.EntityFrameworkCore.Sqlite --version 3.1.1
```
   
6. A continuación, crearemos un nuevo Entity Framework DbContext. Cree una nueva clase `ApplicationDbContext` en la carpeta` Models` usando el siguiente código:
   ```csharp
    using Microsoft.EntityFrameworkCore;

    namespace BackEnd.Models
    {
        public class ApplicationDbContext : DbContext
        {
            public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
                : base(options)
            {

            }

            public DbSet<Speaker> Speakers { get; set; }
        }
    }

    ```
7. Agregue una cadena de conexión al archivo appsettings.json para esta base de datos:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=aspnet-BackEnd-931E56BD-86CB-4A96-BD99-2C6A6ABB0829Trusted_Connection=True;MultipleActiveResultSets=true"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  },
  "AllowedHosts": "*"
}
```

## Registre el servicio de contexto DB

1. Agregue el siguiente código en la parte superior del método `ConfigureServices ()` en `Startup.cs`:

```csharp
services.AddDbContext<ApplicationDbContext>(options =>
{
    if (RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
    {
        options.UseSqlServer(Configuration.GetConnectionString("DefaultConnection"));
    }
    else
    {
        options.UseSqlite("Data Source=conferences.db");
    }
});
```
> Este código registra el servicio `ApplicationDbContext` para que pueda inyectarse en los controladores. Además, configura tecnologías de base de datos específicas del sistema operativo y cadenas de conexión

## Configuración de migraciones EF

1. Agregue una referencia al paquete NuGet `Microsoft.EntityFrameworkCore.Tools` versión` 3.1.1` instale el paquete desde la línea de comandos con `dotnet add package Microsoft.EntityFrameworkCore.Tools --version 3.1.1`

## Línea de comando

1. Instale la herramienta global EntityFramework `dotnet-ef` utilizando el siguiente comando:

```console
dotnet tool install -g dotnet-ef --version 3.1.1
```

1. Abra un símbolo del sistema y navegue hasta el directorio del proyecto. (El directorio que contiene el archivo `Startup.cs`).

1. Ejecute los siguientes comandos en el símbolo del sistema:
    
```console
dotnet build
dotnet ef migrations add Initial
dotnet ef database update
```
Comandos explicados

| Command                                                      | Description                                                                                                                                             |
| ------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `dotnet ef migrations add Initial`  | generates code to create the initial database schema based on the model specified in 'ApplicationDbContext.cs'. `Initial` is the name of the migration. |
| `dotnet ef database update` | creates the database                                                                                                                      
>Para obtener más información sobre estos comandos y andamios en general, consulte [este tutorial](https://docs.microsoft.com/en-us/aspnet/core/tutorials/first-mvc-app/adding-model#add-migración inicial y actualización de la base de datos).

> Si su base de datos alguna vez se encuentra en un mal estado y desea restablecer las cosas, puede usar `dotnet ef database drop` seguido de 'dotnet ef database update' para eliminar su base de datos y ejecutar todas las migraciones nuevamente.

## Un vistazo rápido al controlador de pronóstico del tiempo

Primero, abra la carpeta `Controllers` y eche un vistazo rápido al` WeatherForecastController`. Verá una función simple que corresponde al verbo HTTP GET. Verá la salida de este controlador en un momento, pero primero crearemos nuestro propio controlador API para la clase de modelo `Speakers`.

## Andamios de un controlador API

### Usando la línea cmd

1. Instale el paquete "Microsoft.VisualStudio.Web.CodeGeneration.Design"

```console
dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design --version 3.1.0
```

1. Instale la herramienta global `aspnet-codegenerator` ejecutando el siguiente comando:
    
```console
dotnet tool install -g dotnet-aspnet-codegenerator --version 3.1.0
```

> Nota: Deberá cerrar y volver a abrir la ventana de la consola para poder utilizar esta herramienta.

2. Ejecute lo siguiente en la carpeta del proyecto en la línea cmd:
    
```console
dotnet aspnet-codegenerator controller -api -name SpeakersController -m Speaker -dc BackEnd.Models.ApplicationDbContext -outDir Controllers
```

## Probar la API con Swashbuckle

En esta sección, agregaremos documentación a nuestra API usando el paquete Swashbuckle NuGet.

[Swashbuckle.AspNetCore](https://github.com/domaindrivendev/swashbuckle.aspnetcore) es un proyecto de código abierto para generar documentos Swagger para API web que se crean con ASP.NET Core.

[Swagger](https://swagger.io) es una representación legible por máquina de una API RESTful que permite el soporte de documentación interactiva, generación de SDK del cliente y capacidad de detección.

Información adicional sobre el uso de Swashbuckle en ASP.NET Core está disponible en este tutorial: [Páginas de ayuda de la API web ASP.NET usando Swagger](https://docs.microsoft.com/en-us/aspnet/core/tutorials/web- api-help-pages-using-swagger)

1. Agregue una referencia al paquete NuGet `Swashbuckle.AspNetCore` versión `5.0.0`.
     
> Esto se puede hacer desde la línea de comandos usando `dotnet add package Swashbuckle.AspNetCore --version 5.0.0`

1. Agregue los servicios Swashbuckle en su método `ConfigureServices`:    

```csharp

services.AddControllers();
services.AddSwaggerGen(options =>
    options.SwaggerDoc("v1", new OpenApiInfo { Title = "Conference Planner API", Version = "v1" })
);
```

1. Configure Swashbuckle agregando las siguientes líneas justo antes de `UseRouting` en el método` Configure` en `Startup.cs`:

```csharp
app.UseSwagger();

app.UseSwaggerUI(options =>
  options.SwaggerEndpoint("/swagger/v1/swagger.json", "Conference Planner API v1")
);
```

> ** *Nota:* Debido a cómo está estructurado el middleware y la canalización, querrás colocar esto antes de la declaración `app.UseEndpoints()`.**

2. Ejecute la aplicación (F5 en Visual Studio Code o `dotnet run` desde la consola).

3. Busque la interfaz de usuario de Swagger en `http://localhost:<random_port>/swagger`.
     ![](images/swagger-altavoces.png)

4. Primero, haga clic en el botón *GET* en la sección *WeatherForecast*. Verá los valores que se enumeraron en el `WeatherForecastController` anteriormente.

5. En la sección *Altavoces*, haga clic en el botón *GET*. Verá que no hay altavoces devueltos. ¡Agreguemos uno!
6. En la sección *Altavoces*, haga clic en el botón *POST*. Haciendo referencia al ejemplo de la derecha, complete una solicitud de orador. Deje en blanco la 'ID', que será completada por la base de datos.
    ![](images/swagger-create-speaker.png)

```json
{
    "name": "Tyrion Lannister",
    "bio": "Drinks and knows things",
    "webSite": "http://giphy.com/search/tyrion-lannister"
}
```

1.Cuando hace clic en el botón *Ejecutar*, debería ver una respuesta exitosa del servidor. Ahora, probar el punto final *GET* anterior debería mostrar su altavoz recién agregado.
    ![](images/swagger-create-results.png)

**Siguiente**: [Sesión #2 - Back-end](2.%20Build%20out%20BackEnd%20and%20Refactor.md)
